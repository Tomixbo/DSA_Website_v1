{% extends 'base.html' %}

{% block content %}
<div class="shadow container-fluid p-3 px-4 " style="background-color: #051934;">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="text-white">{{ team.name }} - Members</h2>
        
        {% if is_member %}
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#notificationModal">
                Notifications <span id="notification-count" class="badge bg-danger" style="display: none;"></span>
            </button>
        {% endif %}

        <!-- Modal des notifications -->
        <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="notificationModalLabel">Notifications</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex">
                        {% for request in pending_requests %}
                            <div>
                                <p>{{ request.user.username }} has requested to join the team.</p>
                                <div class="d-flex">
                                    <form method="POST" action="{% url 'accept_request' request.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success">Accept</button>
                                    </form>
                                    <form method="POST" action="{% url 'reject_request' request.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger mx-2">Reject</button>
                                    </form>
                                </div>
                            </div>
                        {% empty %}
                            <p>No pending requests.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container mt-4">

    <table class="table table-bordered mt-3">
        <thead class="table-light">
            <tr>
                <th scope="col">Member Name</th>
            </tr>
        </thead>
        <tbody>
            {% for member in team.members.all %}
                <tr>
                    <td>{{ member.username }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="1" class="text-center">No members in this team.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>



{% comment %} bar de recherche {% endcomment %}
{% if is_member %}
<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <h3 class="mb-3 text-center">Search for a User</h3>
        
        <!-- Formulaire de recherche -->
        <form method="GET" class="mb-4">
            <div class="input-group">
                <input type="text" class="form-control rounded-start" name="search" placeholder="Enter username..." value="{{ query }}">
                <button type="submit" class="btn btn-primary">üîç Search</button>
            </div>
        </form>

        <!-- R√©sultats de recherche -->
        {% if search_results %}
            <h5 class="text-success mb-3">R√©sultats trouv√©s :</h5>
            <ul class="list-group">
                {% for user in search_results %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="fw-bold">{{ user.username }}</span>

                        {% if user not in team.members.all %}
                            <form method="POST" action="{% url 'send_invite' team.id user.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm">‚ûï Inviter</button>
                            </form>
                        {% else %}
                            <span class="badge bg-secondary">D√©j√† membre</span>
                        {% endif %}
                    </li>
                {% empty %}
                    <p class="text-muted text-center mt-3">Aucun utilisateur trouv√©.</p>
                {% endfor %}
            </ul>
        {% endif %}
    </div>
</div>
{% endif %}

{% if is_member %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const notificationBtn = document.getElementById("notification-btn");
    const notificationPopup = document.getElementById("notification-popup");
    const notificationCount = document.getElementById("notification-count");
    const notificationList = document.getElementById("notification-list");

    function fetchNotifications() {
        fetch("{% url 'get_notifications' %}")
            .then(response => response.json())
            .then(data => {
                notificationList.innerHTML = ""; // Effacer les notifications pr√©c√©dentes

                if (data.notifications.length > 0) {
                    notificationCount.style.display = "inline-block";  // Afficher le badge
                    notificationCount.textContent = data.notifications.length;  // Afficher le nombre de notifications
                    data.notifications.forEach(notification => {
                        let li = document.createElement("li");
                        li.className = "p-2 border-bottom";
                        li.innerHTML = `
                            ${notification.message} 
                            <small class="d-block">${notification.created_at}</small>
                            <button class="btn btn-sm btn-success mt-1" onclick="markAsRead(${notification.id}, this)">Mark as Read</button>
                        `;
                        notificationList.appendChild(li);
                    });
                } else {
                    notificationCount.style.display = "none";  // Masquer le badge si aucune notification
                    notificationList.innerHTML = "<li class='text-center'>No notifications</li>";
                }
            });
    }
    function markAsRead(notificationId, button) {
        fetch(`/notifications/mark/${notificationId}/`, { method: "POST" })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.parentElement.remove();
                    fetchNotifications();
                }
            });
    }

    notificationBtn.addEventListener("click", function () {
        notificationPopup.style.display = notificationPopup.style.display === "block" ? "none" : "block";
        fetchNotifications();
    });

    setInterval(fetchNotifications, 10000);
});
</script>
{% endif %}
{% endblock %}
